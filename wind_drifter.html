<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wind Drifter - ã‚ˆã™ããƒ¼ã®éƒ¨å±‹</title>
<style>
  /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS) --- */
  body { font-family: sans-serif; background-color: #fdfdfd; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
  h1 { text-align: center; color: #333; }
  .rules { background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; line-height: 1.6; }
  .bold { font-weight: bold; }
  
  /* ç›¤é¢ã‚°ãƒªãƒƒãƒ‰ */
  .game-board {
    display: grid;
    grid-template-columns: repeat(6, auto);
    gap: 4px;
    justify-content: center;
    margin-bottom: 20px;
  }
  
  /* 1ãƒã‚¹ã®è¨­å®š */
  .cell-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    width: 60px; height: 60px; /* ã‚¹ãƒãƒ›ãªã‚‰å°‘ã—å°ã•ãã—ã¦ã‚‚OK */
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f8f9fa;
    font-size: 10px;
    position: relative;
  }
  
  /* ãƒã‚¹ã®è‰²åˆ†ã‘ */
  .type-L { background-color: #ffebee; border: 2px solid #f44336; color: #b71c1c; } /* ä½æ°—åœ§(èµ¤) */
  .type-H { background-color: #e3f2fd; border: 2px solid #2196f3; color: #0d47a1; } /* é«˜æ°—åœ§(é’) */
  .type-Goal { background-color: #e8f5e9; border: 2px dashed #4caf50; }
  .current-pos { border: 3px solid #ff9800 !important; box-shadow: 0 0 8px rgba(255, 152, 0, 0.6); z-index: 10; }
  
  /* ãƒã‚¹ã®ä¸­èº« (3x3) */
  .sub-cell { display: flex; align-items: center; justify-content: center; }
  .center-char { font-weight: bold; font-size: 16px; }
  .arrow { font-size: 10px; opacity: 0.7; color: #333; font-weight: bold;}
  
  /* æ“ä½œãƒ‘ãƒãƒ« */
  .control-panel { background: #eee; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
  .btn-group { display: grid; grid-template-columns: repeat(3, 50px); gap: 5px; justify-content: center; margin: 10px auto; }
  button { padding: 10px; cursor: pointer; font-size: 16px; border: 1px solid #999; border-radius: 4px; background: #fff; }
  button:hover { background: #e0e0e0; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .action-btn { width: 100%; max-width: 200px; padding: 12px; font-weight: bold; background: #2196f3; color: white; border: none; }
  .action-btn:hover { background: #1976d2; }
  
  /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
  .log-area { width: 100%; height: 150px; border: 1px solid #ccc; background: #fff; overflow-y: scroll; padding: 10px; font-family: monospace; font-size: 13px; box-sizing: border-box; }
  .log-entry { margin-bottom: 4px; border-bottom: 1px dotted #eee; }
</style>
</head>
<body>

<h1>ğŸˆ Wind Drifter</h1>

<div class="rules">
  <p>ã‚ãªãŸã¯æ°—çƒã‚’æ“ä½œã—ã€é¢¨ã«ä¹—ã£ã¦ä¸€ç•ªå·¦ã®åˆ—ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚</p>
  <p><span class="bold">ï¼œãƒ«ãƒ¼ãƒ«ï¼</span></p>
  <ul>
    <li>æ¯ã‚¿ãƒ¼ãƒ³ã®æµã‚Œã¯ã€ã€Œç§»å‹•ã€â†’ã€Œåè¥¿é¢¨ã€â†’ã€Œæ¼‚æµã€ã§ã™ã€‚</li>
    <li><span class="bold">ã€Œç§»å‹•ã€</span>ï¼šæ°—çƒã‚’å¥½ããªå‘ãã«ï¼‘ãƒã‚¹ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
    <li><span class="bold">ã€Œåè¥¿é¢¨ã€</span>ï¼šã™ã¹ã¦ã®ä½æ°—åœ§ã¨é«˜æ°—åœ§ãŒå³ã«ï¼‘ãƒã‚¹ç§»å‹•ã—ã¾ã™ã€‚ãã—ã¦ã€ä¸€ç•ªå·¦ã®åˆ—ã«æ–°ãŸãªé«˜æ°—åœ§ã‹ä½æ°—åœ§ãŒå‡ºç¾ã—ã¾ã™ã€‚</li>
    <li><span class="bold">ã€Œæ¼‚æµã€</span>ï¼šæ°—çƒã¯ã€å‘¨å›²ã®é«˜æ°—åœ§ã¨ä½æ°—åœ§ã®é¢¨ã®å½±éŸ¿ã‚’å—ã‘ã¦æ¼‚æµã—ã¾ã™ã€‚æ¼‚æµå¾Œã«ã•ã‚‰ã«æ¼‚æµã§ãã‚‹å ´åˆã¯ã€ï¼’å›ã¾ã§æ¼‚æµã—ã¾ã™ã€‚</li>
  </ul>
  <p><span class="bold">ï¼œå‹åˆ©æ¡ä»¶ï¼</span> ç§»å‹•ã¾ãŸã¯æ¼‚æµã§ã€ä¸€ç•ªå·¦ã®åˆ—ã«åˆ°é”ã™ã‚Œã°ã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã™ã€‚ä½æ°—åœ§ã¨è¢«ã•ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ˆå¢œè½ï¼‰ã«ãªã‚Šã¾ã™ã€‚</p>
</div>

<div id="board" class="game-board"></div>

<div class="control-panel">
  <h3 id="phase-title">1. ç§»å‹•ã®æ“ä½œ</h3>
  <div id="controls-move" class="btn-group">
    <button onclick="actionMove(-1, -1)">â†–ï¸</button> <button onclick="actionMove(-1, 0)">â¬†ï¸</button> <button onclick="actionMove(-1, 1)">â†—ï¸</button>
    <button onclick="actionMove(0, -1)">â¬…ï¸</button> <button onclick="actionMove(0, 0)">â¹ï¸</button> <button onclick="actionMove(0, 1)">â¡ï¸</button>
    <button onclick="actionMove(1, -1)">â†™ï¸</button> <button onclick="actionMove(1, 0)">â¬‡ï¸</button> <button onclick="actionMove(1, 1)">â†˜ï¸</button>
  </div>
  
  <div id="controls-westerlies" style="display:none;">
    <button class="action-btn" onclick="actionWesterlies()">ğŸŒ¬ï¸ åè¥¿é¢¨é–‹å§‹</button>
  </div>
  
  <div id="controls-drift" style="display:none;">
    <button id="btn-drift" class="action-btn" onclick="actionDriftStep()">ğŸŒŠ æ¼‚æµé–‹å§‹</button>
  </div>
  
  <div id="controls-reset" style="display:none; margin-top:10px;">
    <button class="action-btn" style="background:#f44336;" onclick="initGame()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  </div>
</div>

<div class="bold">å±¥æ­´</div>
<div id="logs" class="log-area"></div>

<script>
// --- è¨­å®šã¨å®šç¾© ---
const ROWS = 5;
const COLS = 6;
const ICON_BALLOON = "ğŸˆ";
const ICON_GOAL = "ğŸ";

// é¢¨å‘ããƒ‡ãƒ¼ã‚¿ (è¨­è¨ˆå›³æº–æ‹ )
const L_WIND = {
  "-1,-1": [1, 0],  "-1,0": [1, -1],  "-1,1": [0, -1],
  "0,-1":  [1, 1],                    "0,1":  [-1, -1],
  "1,-1":  [0, 1],  "1,0":  [-1, 1],  "1,1":  [-1, 0]
};
const H_WIND = {
  "-1,-1": [-1, 0], "-1,0": [-1, 1],  "-1,1": [0, 1],
  "0,-1":  [-1, -1],                  "0,1":  [1, 1],
  "1,-1":  [0, -1], "1,0":  [1, -1],  "1,1":  [1, 0]
};
// ãƒ™ã‚¯ãƒˆãƒ«ã‹ã‚‰çŸ¢å°æ–‡å­—
function vecToArrow(r, c) {
  if (r==0 && c==0) return "";
  if (r==-1 && c==0) return "â¬†ï¸"; if (r==1 && c==0) return "â¬‡ï¸";
  if (r==0 && c==-1) return "â¬…ï¸"; if (r==0 && c==1) return "â¡ï¸";
  if (r==-1 && c==-1) return "â†–ï¸"; if (r==-1 && c==1) return "â†—ï¸";
  if (r==1 && c==-1) return "â†™ï¸"; if (r==1 && c==1) return "â†˜ï¸";
  return "";
}

// --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
let board = {}; // Key: "r,c", Value: "L" or "H"
let playerPos = {r: 2, c: 5};
let phase = "MOVE"; // MOVE, WESTERLIES, DRIFT
let driftStep = 0;
let gameOver = false;
let turnCount = 1;

// --- åˆæœŸåŒ– ---
function initGame() {
  board = {};
  playerPos = {r: 2, c: 5};
  phase = "MOVE";
  driftStep = 0;
  gameOver = false;
  turnCount = 1;
  document.getElementById("logs").innerHTML = "";
  addLog("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ç§»å‹•æ–¹å‘ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚");
  
  // åˆæœŸé…ç½®
  for(let c=0; c<3; c++) {
    let r = Math.floor(Math.random() * ROWS);
    board[`${r},${c}`] = Math.random() < 0.4 ? "L" : "H";
  }
  render();
}

// --- ãƒ­ã‚°æ©Ÿèƒ½ ---
function addLog(msg) {
  const logDiv = document.getElementById("logs");
  const entry = document.createElement("div");
  entry.className = "log-entry";
  entry.innerText = msg;
  logDiv.prepend(entry);
}

// --- é¢¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
function getWindVector(r, c, currentBoard) {
  let vectors = [];
  
  // 1. ä¸Šä¸‹å·¦å³
  let ortho = [[-1,0], [1,0], [0,-1], [0,1]];
  let foundOrtho = false;
  
  for(let d of ortho) {
    let tr = r + d[0];
    let tc = c + d[1];
    let key = `${tr},${tc}`;
    if (currentBoard[key]) {
      let type = currentBoard[key];
      // ã‚«ãƒ¼ãƒ‰ã‹ã‚‰è¦‹ãŸè‡ªåˆ†ã®ä½ç½® (-dr, -dc)
      let relKey = `${-d[0]},${-d[1]}`;
      let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
      vectors.push(w);
      foundOrtho = true;
    }
  }
  
  // 2. æ–œã‚ (ä¸Šä¸‹å·¦å³ãŒãªã„å ´åˆã®ã¿)
  if (!foundOrtho) {
    let diag = [[-1,-1], [-1,1], [1,-1], [1,1]];
    for(let d of diag) {
      let tr = r + d[0];
      let tc = c + d[1];
      let key = `${tr},${tc}`;
      if (currentBoard[key]) {
        let type = currentBoard[key];
        let relKey = `${-d[0]},${-d[1]}`;
        let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
        vectors.push(w);
      }
    }
  }
  
  if (vectors.length === 0) return [0, 0];
  
  // åˆæˆ
  let resR = 0, resC = 0;
  for(let v of vectors) { resR += v[0]; resC += v[1]; }
  
  // ä¸¸ã‚
  if (Math.abs(resR)===1 && Math.abs(resC)>=3) { resR=0; resC = resC>0 ? 2 : -2; }
  if (Math.abs(resC)===1 && Math.abs(resR)>=3) { resC=0; resR = resR>0 ? 2 : -2; }
  
  return [resR, resC];
}

// --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

// 1. ç§»å‹•
function actionMove(dr, dc) {
  if (gameOver) return;
  
  let pr = playerPos.r;
  let pc = playerPos.c;
  let nr = Math.max(0, Math.min(ROWS-1, pr + dr));
  let nc = Math.max(0, Math.min(COLS-1, pc + dc));
  
  if (board[`${nr},${nc}`] === "H") {
    addLog("âš ï¸ é«˜æ°—åœ§ã®å£ã«é˜»ã¾ã‚Œã¾ã—ãŸï¼(ç§»å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«)");
  } else {
    playerPos = {r: nr, c: nc};
    if (dr===0 && dc===0) addLog("ğŸ›‘ å¾…æ©Ÿã—ã¾ã—ãŸã€‚");
    else addLog("ğŸˆ æ°—çƒã‚’æ“ä½œã—ã¾ã—ãŸã€‚");
  }
  
  phase = "WESTERLIES";
  render();
}

// 2. åè¥¿é¢¨
function actionWesterlies() {
  if (gameOver) return;
  
  let newBoard = {};
  // å³ã‚·ãƒ•ãƒˆ
  for(let key in board) {
    let [br, bc] = key.split(",").map(Number);
    if (bc + 1 < COLS) {
      newBoard[`${br},${bc+1}`] = board[key];
    }
  }
  board = newBoard;
  
  // ç™ºç”Ÿ
  if (Math.random() < 0.8) {
    let spawnR = Math.floor(Math.random() * ROWS);
    let type = Math.random() < 0.4 ? "L" : "H";
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®å›é¿
    if (spawnR !== playerPos.r || 0 !== playerPos.c) {
      board[`${spawnR},0`] = type;
      addLog(`ğŸŒªï¸ è¥¿ã‹ã‚‰${type === 'L' ? 'ä½æ°—åœ§' : 'é«˜æ°—åœ§'}ãŒç™ºç”Ÿ (åè¥¿é¢¨)ã€‚`);
    }
  } else {
    addLog("ğŸ’¨ æ–°ãŸãªæ“¾ä¹±ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
  
  phase = "DRIFT";
  driftStep = 0;
  render();
}

// 3. æ¼‚æµ
function actionDriftStep() {
  if (gameOver) return;
  
  let [wr, wc] = getWindVector(playerPos.r, playerPos.c, board);
  
  // é¢¨ãŒãªã„å ´åˆ
  if (wr === 0 && wc === 0) {
    addLog("ğŸƒ è¿‘ãã«é¢¨ã¯ãªãã€æ¼‚æµã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
    endDriftPhase();
    return;
  }
  
  // ç§»å‹•å…ˆ
  let nr = playerPos.r + wr;
  let nc = playerPos.c + wc;
  
  // å£åˆ¤å®š (ç¯„å›²å¤–ãªã‚‰å‹•ã‹ãªã„)
  if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
    playerPos = {r: nr, c: nc};
    addLog(`ğŸŒŠ é¢¨ã«æµã•ã‚Œã¦ã„ã¾ã™... (${wr}, ${wc})`);
    driftStep++;
  } else {
    addLog("ğŸ§± å£ã«ã¶ã¤ã‹ã‚Šã€æ¼‚æµã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    endDriftPhase();
    return;
  }
  
  // Lè¡çªåˆ¤å®š
  if (board[`${playerPos.r},${playerPos.c}`] === "L") {
    gameOver = true;
    addLog("ğŸ’€ ä½æ°—åœ§ã®ä¸­å¿ƒã«å¸ã„è¾¼ã¾ã‚Œã¾ã—ãŸ... GAME OVER");
    render();
    return;
  }
  
  // é€£é–åˆ¤å®š
  let [nextWr, nextWc] = getWindVector(playerPos.r, playerPos.c, board);
  if (driftStep < 2 && (nextWr !== 0 || nextWc !== 0)) {
    addLog("ğŸŒªï¸ ã¾ã é¢¨ã«ä¹—ã£ã¦ã„ã¾ã™ã€‚ã€Œè¿½åŠ ã§æ¼‚æµã€ã—ã¦ãã ã•ã„ã€‚");
    render(); // ãƒœã‚¿ãƒ³æ›´æ–°ã®ãŸã‚
  } else {
    addLog("âš“ï¸ æ¼‚æµãŒæ­¢ã¾ã‚Šã¾ã—ãŸã€‚");
    endDriftPhase();
  }
}

function endDriftPhase() {
  if (playerPos.c === 0) {
    gameOver = true;
    addLog("ğŸ‰ ã‚´ãƒ¼ãƒ«åˆ°é”ï¼ CLEAR!!");
    render();
    return;
  }
  phase = "MOVE";
  turnCount++;
  addLog(`--- ã‚¿ãƒ¼ãƒ³ ${turnCount} é–‹å§‹ ---`);
  render();
}

// --- æç”»é–¢æ•° ---
function render() {
  const boardDiv = document.getElementById("board");
  boardDiv.innerHTML = "";
  
  // ç›¤é¢ç”Ÿæˆ
  for(let r=0; r<ROWS; r++) {
    for(let c=0; c<COLS; c++) {
      let cell = document.createElement("div");
      cell.className = "cell-container";
      
      let type = board[`${r},${c}`];
      if (type === "L") cell.classList.add("type-L");
      else if (type === "H") cell.classList.add("type-H");
      else if (c === 0) cell.classList.add("type-Goal");
      
      if (playerPos.r === r && playerPos.c === c) cell.classList.add("current-pos");
      
      // 3x3ã‚µãƒ–ã‚°ãƒªãƒƒãƒ‰
      for(let dr=-1; dr<=1; dr++) {
        for(let dc=-1; dc<=1; dc++) {
          let sub = document.createElement("div");
          sub.className = "sub-cell";
          
          if (dr===0 && dc===0) { // ä¸­å¿ƒ
            sub.classList.add("center-char");
            if (playerPos.r === r && playerPos.c === c) sub.innerText = ICON_BALLOON;
            else if (type === "L") sub.innerText = "ä½";
            else if (type === "H") sub.innerText = "é«˜";
            else if (c === 0) sub.innerText = ICON_GOAL;
          } else if (type) { // å‘¨å›²ã®çŸ¢å°
            // ã“ã®ãƒã‚¹(type)ãŒã€ç›¸å¯¾ä½ç½®(dr,dc)ã«åŠã¼ã™é¢¨ã‚’è¡¨ç¤º
            // JSã®Mapã‚­ãƒ¼ã¯æ–‡å­—åˆ—
            let w = (type === "L" ? L_WIND[`${dr},${dc}`] : H_WIND[`${dr},${dc}`]) || [0,0];
            let arrow = vecToArrow(w[0], w[1]);
            if (arrow) {
              sub.innerText = arrow;
              sub.classList.add("arrow");
            }
          }
          cell.appendChild(sub);
        }
      }
      boardDiv.appendChild(cell);
    }
  }
  
  // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.getElementById("controls-move").style.display = "none";
  document.getElementById("controls-westerlies").style.display = "none";
  document.getElementById("controls-drift").style.display = "none";
  document.getElementById("controls-reset").style.display = gameOver ? "block" : "none";
  
  let pTitle = document.getElementById("phase-title");
  
  if (!gameOver) {
    if (phase === "MOVE") {
      pTitle.innerText = "1. ç§»å‹•ã®æ“ä½œ";
      document.getElementById("controls-move").style.display = "grid";
    } else if (phase === "WESTERLIES") {
      pTitle.innerText = "2. åè¥¿é¢¨";
      document.getElementById("controls-westerlies").style.display = "block";
    } else if (phase === "DRIFT") {
      pTitle.innerText = driftStep === 0 ? "3. æ¼‚æµ (1å›ç›®)" : "3. æ¼‚æµ (2å›ç›®)";
      let btn = document.getElementById("btn-drift");
      btn.innerText = driftStep === 0 ? "ğŸŒŠ æ¼‚æµé–‹å§‹" : "ğŸŒŠğŸŒŠ è¿½åŠ ã§æ¼‚æµ";
      document.getElementById("controls-drift").style.display = "block";
    }
  } else {
    pTitle.innerText = "ã‚²ãƒ¼ãƒ çµ‚äº†";
  }
}

// åˆæœŸåŒ–å®Ÿè¡Œ
initGame();
</script>
</body>
</html>