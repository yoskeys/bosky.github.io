<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wind Drifter (ã†ã•ããƒ¢ãƒ¼ãƒ‰) - ã‚ˆã™ããƒ¼ã®éƒ¨å±‹</title>
<style>
  /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (é€šå¸¸ç›¤ã¨åŒã˜CSS) --- */
  body { font-family: sans-serif; background-color: #fdfdfd; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
  a.back-link { display: inline-block; margin-bottom: 15px; color: #0056b3; text-decoration: none; }
  h1 { text-align: center; color: #333; margin-top: 0; margin-bottom: 10px;}
  
  .turn-indicator {
    text-align: center; font-size: 1.2rem; font-weight: bold; color: #0056b3;
    margin-bottom: 15px; padding: 5px; background-color: #e3f2fd;
    border-radius: 4px; display: inline-block;
  }
  .turn-wrapper { text-align: center; }

  .rules { background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; line-height: 1.6; }
  .bold { font-weight: bold; color: #e91e63; } /* ã†ã•ããƒ¢ãƒ¼ãƒ‰ã®å¼·èª¿è‰² */
  
  .game-board { display: grid; grid-template-columns: repeat(6, auto); gap: 4px; justify-content: center; margin-bottom: 20px; }
  
  .cell-container {
    display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
    width: 60px; height: 60px; border: 1px solid #ccc; border-radius: 4px;
    background-color: #f8f9fa; font-size: 10px; position: relative;
  }
  
  .type-L { background-color: #ffebee; border: 2px solid #f44336; color: #b71c1c; } 
  .type-H { background-color: #e3f2fd; border: 2px solid #2196f3; color: #0d47a1; } 
  
  /* ã†ã•ãã®ã„ã‚‹ãƒã‚¹ã‚’å°‘ã—å¼·èª¿ */
  .rabbit-pos { box-shadow: inset 0 0 10px rgba(255, 105, 180, 0.4); border: 2px solid #ff69b4; }
  .current-pos { border: 3px solid #ff9800 !important; box-shadow: 0 0 8px rgba(255, 152, 0, 0.6); z-index: 10; }
  
  .sub-cell { display: flex; align-items: center; justify-content: center; }
  .center-char { font-weight: bold; font-size: 16px; }
  .arrow { font-size: 10px; opacity: 0.7; color: #333; font-weight: bold;}
  
  .control-panel { background: #eee; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
  .btn-group { display: grid; grid-template-columns: repeat(3, 50px); gap: 5px; justify-content: center; margin: 10px auto; }
  button { padding: 10px; cursor: pointer; font-size: 16px; border: 1px solid #999; border-radius: 4px; background: #fff; }
  button:hover { background: #e0e0e0; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .action-btn { width: 100%; max-width: 200px; padding: 12px; font-weight: bold; background: #2196f3; color: white; border: none; }
  .action-btn:hover { background: #1976d2; }
  
  .log-area { width: 100%; height: 150px; border: 1px solid #ccc; background: #fff; overflow-y: scroll; padding: 10px; font-family: monospace; font-size: 13px; box-sizing: border-box; }
  .log-entry { margin-bottom: 4px; border-bottom: 1px dotted #eee; }

  @media (max-width: 600px) {
    .cell-container { width: 45px; height: 45px; font-size: 8px; }
    .btn-group { grid-template-columns: repeat(3, 45px); }
    button { padding: 8px; font-size: 14px; }
  }
</style>
</head>
<body>

<a href="../minigames.html" class="back-link">â† ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ä¸€è¦§ã«æˆ»ã‚‹</a>

<h1>ğŸˆ Wind Drifter <span style="font-size:0.8em; color:#e91e63;">(ã†ã•ã)</span></h1>

<div class="rules">
  <p>é¢¨ã«ä¹—ã£ã¦é€ƒã’å›ã‚‹<span class="bold">ã€Œã†ã•ã(ğŸ°)ã€</span>ã‚’æ•ã¾ãˆã‚‹é¬¼ã”ã£ã“ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚</p>
  <p><span class="bold">ï¼œãƒ«ãƒ¼ãƒ«ï¼</span></p>
  <ul>
    <li><span class="bold">å‹åˆ©æ¡ä»¶</span>ï¼šç§»å‹•ã‚„æ¼‚æµã§ã€ã†ã•ãã¨åŒã˜ãƒã‚¹ã«å…¥ã‚‹ã“ã¨ã€‚</li>
    <li><span class="bold">æ•—åŒ—æ¡ä»¶</span>ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ãŸã¯<span class="bold" style="color:#f44336;">ã†ã•ããŒä½æ°—åœ§(L)ã®ä¸­å¿ƒã«å…¥ã£ã¦ã—ã¾ã†</span>ã“ã¨ã€‚</li>
    <li>ã†ã•ãã¯ã€ã‚ãªãŸãŒå‹•ã„ãŸç›´å¾Œã«ã€Œã‚ãªãŸã‹ã‚‰é ã–ã‹ã‚‹æ–¹å‘ã€ã¸é€ƒã’ã¾ã™ã€‚</li>
    <li>ã†ã•ãã‚‚é¢¨ã®å½±éŸ¿ã‚’å—ã‘ã¦æ¼‚æµã—ã¾ã™ã€‚ä½æ°—åœ§ã«é£›ã³è¾¼ã¾ãªã„ã‚ˆã†ã«èª˜å°ã—ã¾ã—ã‚‡ã†ã€‚</li>
  </ul>
</div>

<div class="turn-wrapper">
    <div class="turn-indicator">ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span id="turn-num">1</span></div>
</div>

<div id="board" class="game-board"></div>

<div class="control-panel">
  <h3 id="phase-title">1. ç§»å‹•ã®æ“ä½œ</h3>
  <div id="controls-move" class="btn-group">
    <button onclick="actionMove(-1, -1)">â†–ï¸</button> <button onclick="actionMove(-1, 0)">â¬†ï¸</button> <button onclick="actionMove(-1, 1)">â†—ï¸</button>
    <button onclick="actionMove(0, -1)">â¬…ï¸</button> <button onclick="actionMove(0, 0)">â¹ï¸</button> <button onclick="actionMove(0, 1)">â¡ï¸</button>
    <button onclick="actionMove(1, -1)">â†™ï¸</button> <button onclick="actionMove(1, 0)">â¬‡ï¸</button> <button onclick="actionMove(1, 1)">â†˜ï¸</button>
  </div>
  
  <div id="controls-westerlies" style="display:none;">
    <button class="action-btn" onclick="actionWesterlies()">ğŸŒ¬ï¸ åè¥¿é¢¨é–‹å§‹</button>
  </div>
  
  <div id="controls-drift" style="display:none;">
    <button id="btn-drift" class="action-btn" onclick="actionDriftStep()">ğŸŒŠ æ¼‚æµé–‹å§‹</button>
  </div>
  
  <div id="controls-reset" style="display:none; margin-top:10px;">
    <button id="btn-reset" class="action-btn" style="background:#f44336;" onclick="initGame()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  </div>
</div>

<div class="bold">å±¥æ­´</div>
<div id="logs" class="log-area"></div>

<script>
// --- è¨­å®šã¨å®šç¾© ---
const ROWS = 5;
const COLS = 6;
const ICON_BALLOON = "ğŸˆ";
const ICON_RABBIT = "ğŸ°"; // ã†ã•ãã‚¢ã‚¤ã‚³ãƒ³

const L_WIND = { "-1,-1": [1, 0], "-1,0": [1, -1], "-1,1": [0, -1], "0,-1": [1, 1], "0,1": [-1, -1], "1,-1": [0, 1], "1,0": [-1, 1], "1,1": [-1, 0] };
const H_WIND = { "-1,-1": [-1, 0], "-1,0": [-1, 1], "-1,1": [0, 1], "0,-1": [-1, -1], "0,1": [1, 1], "1,-1": [0, -1], "1,0": [1, -1], "1,1": [1, 0] };

function vecToArrow(r, c) {
  if (r==0 && c==0) return "";
  if (r==-1 && c==0) return "â¬†ï¸"; if (r==1 && c==0) return "â¬‡ï¸";
  if (r==0 && c==-1) return "â¬…ï¸"; if (r==0 && c==1) return "â¡ï¸";
  if (r==-1 && c==-1) return "â†–ï¸"; if (r==-1 && c==1) return "â†—ï¸";
  if (r==1 && c==-1) return "â†™ï¸"; if (r==1 && c==1) return "â†˜ï¸";
  return "";
}

// --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
let board = {}; 
let playerPos = {r: 2, c: 5};
let rabbitPos = {r: 2, c: 0}; // ã†ã•ãã®åˆæœŸä½ç½®ï¼ˆå·¦å´ï¼‰
let phase = "MOVE";
let driftStep = 0;
let gameOver = false;
let gameWon = false;
let turnCount = 1;

// --- åˆæœŸåŒ– ---
function initGame() {
  board = {};
  playerPos = {r: Math.floor(ROWS/2), c: COLS-1}; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å³ç«¯ä¸­å¤®
  rabbitPos = {r: Math.floor(ROWS/2), c: 0};      // ã†ã•ãã¯å·¦ç«¯ä¸­å¤®
  phase = "MOVE";
  driftStep = 0;
  gameOver = false;
  gameWon = false;
  turnCount = 1;
  updateTurnDisplay();
  document.getElementById("logs").innerHTML = "";
  addLog("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ğŸ°ã‚’æ•ã¾ãˆã¦ãã ã•ã„ã€‚ï¼ˆä½æ°—åœ§ã«æ³¨æ„ï¼ï¼‰");
  
  // åˆæœŸé…ç½®ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã†ã•ãã®ä½ç½®ã¯é¿ã‘ã‚‹ï¼‰
  for(let c=0; c<3; c++) {
    let placed = false;
    while(!placed) {
        let r = Math.floor(Math.random() * ROWS);
        if ((r !== playerPos.r || c !== playerPos.c) && (r !== rabbitPos.r || c !== rabbitPos.c)) {
            board[`${r},${c}`] = Math.random() < 0.4 ? "L" : "H";
            placed = true;
        }
    }
  }

  render();
}

function updateTurnDisplay() {
    document.getElementById("turn-num").innerText = turnCount;
}

function addLog(msg) {
  const logDiv = document.getElementById("logs");
  const entry = document.createElement("div");
  entry.className = "log-entry";
  entry.innerText = msg;
  logDiv.prepend(entry);
}

function getWindVector(r, c, currentBoard) {
  let vectors = [];
  let ortho = [[-1,0], [1,0], [0,-1], [0,1]];
  let foundOrtho = false;
  
  for(let d of ortho) {
    let tr = r + d[0];
    let tc = c + d[1];
    let key = `${tr},${tc}`;
    if (currentBoard[key]) {
      let type = currentBoard[key];
      let relKey = `${-d[0]},${-d[1]}`;
      let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
      vectors.push(w);
      foundOrtho = true;
    }
  }
  
  if (!foundOrtho) {
    let diag = [[-1,-1], [-1,1], [1,-1], [1,1]];
    for(let d of diag) {
      let tr = r + d[0];
      let tc = c + d[1];
      let key = `${tr},${tc}`;
      if (currentBoard[key]) {
        let type = currentBoard[key];
        let relKey = `${-d[0]},${-d[1]}`;
        let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
        vectors.push(w);
      }
    }
  }
  
  if (vectors.length === 0) return [0, 0];
  
  let resR = 0, resC = 0;
  for(let v of vectors) { resR += v[0]; resC += v[1]; }
  
  if (Math.abs(resR)===1 && Math.abs(resC)>=3) { resR=0; resC = resC>0 ? 2 : -2; }
  if (Math.abs(resC)===1 && Math.abs(resR)>=3) { resC=0; resR = resR>0 ? 2 : -2; }
  
  return [resR, resC];
}

// --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
function checkWin() {
    if (playerPos.r === rabbitPos.r && playerPos.c === rabbitPos.c) {
        gameOver = true;
        gameWon = true;
        addLog(`ğŸ‰ ã†ã•ãã‚’æ•ã¾ãˆãŸï¼ (è¨˜éŒ²: ${turnCount}ã‚¿ãƒ¼ãƒ³) CLEAR!!`);
        render();
        return true;
    }
    return false;
}

function checkLDeath(pos, who) {
    if (board[`${pos.r},${pos.c}`] === "L") {
        gameOver = true;
        gameWon = false;
        let msg = who === "player" ? "ğŸ’€ ã‚ãªãŸã¯ä½æ°—åœ§ã«å¸ã„è¾¼ã¾ã‚Œã¾ã—ãŸ..." : "ğŸ˜± ã†ã•ããŒä½æ°—åœ§ã«é£›ã³è¾¼ã‚“ã§ã—ã¾ã£ãŸï¼(ä¿è­·å¤±æ•—)";
        addLog(msg + " GAME OVER");
        render();
        return true;
    }
    return false;
}

// --- ã†ã•ãAI ---
function moveRabbitAI() {
    if (gameOver) return;

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰é ã–ã‹ã‚‹æ–¹å‘ã‚’è¨ˆç®— (å˜ç´”ãªé€†ãƒ™ã‚¯ãƒˆãƒ«)
    let dr = rabbitPos.r - playerPos.r;
    let dc = rabbitPos.c - playerPos.c;
    
    // -1, 0, 1 ã«æ­£è¦åŒ–
    let moveR = Math.sign(dr);
    let moveC = Math.sign(dc);

    // ç§»å‹•å…ˆå€™è£œ
    let nr = rabbitPos.r + moveR;
    let nc = rabbitPos.c + moveC;

    // å£(H)ã‚„ç›¤é¢å¤–ãƒã‚§ãƒƒã‚¯
    if (nr < 0 || nr >= ROWS || nc < 0 || nc >= COLS || board[`${nr},${nc}`] === "H") {
        // å‹•ã‘ãªã„å ´åˆã¯ãã®å ´ã«ç•™ã¾ã‚‹ï¼ˆå˜ç´”åŒ–ã®ãŸã‚ï¼‰
        addLog("ğŸ° ã†ã•ãã¯é€ƒã’å ´ãŒãªãã€éœ‡ãˆã¦ã„ã‚‹ã€‚(å¾…æ©Ÿ)");
    } else {
        // ç§»å‹•å®Ÿè¡Œï¼ˆå±é™ºãªLã§ã‚ã£ã¦ã‚‚çªã£è¾¼ã‚€ï¼ï¼‰
        rabbitPos = {r: nr, c: nc};
        addLog(`ğŸ° ã†ã•ããŒé€ƒã’ãŸï¼`);
    }

    // ç§»å‹•å¾Œã®åˆ¤å®š
    if (checkWin()) return; // è‡ªã‚‰é£›ã³è¾¼ã‚“ã§ããŸå ´åˆ
    if (checkLDeath(rabbitPos, "rabbit")) return; // è‡ªæ»…ã—ãŸå ´åˆ

    // ãƒ•ã‚§ãƒ¼ã‚ºã‚’åè¥¿é¢¨ã¸
    phase = "WESTERLIES";
    render();
}


// --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

// 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
function actionMove(dr, dc) {
  if (gameOver) return;
  
  let nr = Math.max(0, Math.min(ROWS-1, playerPos.r + dr));
  let nc = Math.max(0, Math.min(COLS-1, playerPos.c + dc));
  
  if (board[`${nr},${nc}`] === "H") {
    addLog("âš ï¸ é«˜æ°—åœ§ã®å£ã«é˜»ã¾ã‚Œã¾ã—ãŸï¼(ç§»å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«)");
    // ç§»å‹•ã§ããªãã¦ã‚‚ã†ã•ãã¯å‹•ãã“ã¨ã«ã™ã‚‹
  } else {
    playerPos = {r: nr, c: nc};
    if (dr===0 && dc===0) addLog("ğŸ›‘ å¾…æ©Ÿã—ã¾ã—ãŸã€‚");
    else addLog("ğŸˆ æ°—çƒã‚’æ“ä½œã—ã¾ã—ãŸã€‚");
  }

  if (checkWin()) return; // ç§»å‹•ã—ã¦æ•ã¾ãˆãŸ

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•å¾Œã«ã†ã•ããŒå‹•ã
  setTimeout(moveRabbitAI, 300); // å°‘ã—ã‚¦ã‚§ã‚¤ãƒˆã‚’å…¥ã‚Œã¦è¦‹ã‚„ã™ã
}

// 2. åè¥¿é¢¨ (æ—¢å­˜é€šã‚Š)
function actionWesterlies() {
  if (gameOver) return;
  
  let newBoard = {};
  for(let key in board) {
    let [br, bc] = key.split(",").map(Number);
    if (bc + 1 < COLS) {
      newBoard[`${br},${bc+1}`] = board[key];
    }
  }
  board = newBoard;
  
  if (Math.random() < 0.8) {
    let spawnR = Math.floor(Math.random() * ROWS);
    let type = Math.random() < 0.4 ? "L" : "H";
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã†ã•ãã®ä½ç½®ã¯é¿ã‘ã¦ç™ºç”Ÿã•ã›ã‚‹ï¼ˆå³æ­»å›é¿ï¼‰
    if ((spawnR !== playerPos.r || 0 !== playerPos.c) && (spawnR !== rabbitPos.r || 0 !== rabbitPos.c)) {
      board[`${spawnR},0`] = type;
      addLog(`ğŸŒªï¸ è¥¿ã‹ã‚‰${type === 'L' ? 'ä½æ°—åœ§' : 'é«˜æ°—åœ§'}ãŒç™ºç”Ÿã€‚`);
    } else {
       addLog("ğŸ’¨ (ä½ç½®è¢«ã‚Šã®ãŸã‚æ“¾ä¹±ç™ºç”Ÿã‚­ãƒ£ãƒ³ã‚»ãƒ«)");
    }
  } else {
    addLog("ğŸ’¨ æ–°ãŸãªæ“¾ä¹±ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
  
  phase = "DRIFT";
  driftStep = 0;
  render();
}

// 3. æ¼‚æµ (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã†ã•ãä¸¡æ–¹)
function actionDriftStep() {
  if (gameOver) return;

  // æ¼‚æµé–‹å§‹æ™‚ã®Låˆ¤å®šãƒã‚§ãƒƒã‚¯
  if (checkLDeath(playerPos, "player")) return;
  if (checkLDeath(rabbitPos, "rabbit")) return;
  
  // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¼‚æµ ---
  let [pWr, pWc] = getWindVector(playerPos.r, playerPos.c, board);
  let pMoved = false;
  if (pWr !== 0 || pWc !== 0) {
      let nr = playerPos.r + pWr;
      let nc = playerPos.c + pWc;
      if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
          playerPos = {r: nr, c: nc};
          addLog(`ğŸŒŠ ã‚ãªãŸã¯é¢¨ã«æµã•ã‚Œã¾ã—ãŸ... (${pWr}, ${pWc})`);
          pMoved = true;
      } else {
          addLog("ğŸ§± ã‚ãªãŸã¯å£ã«ã¶ã¤ã‹ã‚Šã¾ã—ãŸã€‚");
      }
  } else {
      addLog("ğŸƒ ã‚ãªãŸã®å‘¨ã‚Šã«é¢¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
  }

  // --- ã†ã•ãã®æ¼‚æµ ---
  let [rWr, rWc] = getWindVector(rabbitPos.r, rabbitPos.c, board);
  let rMoved = false;
  if (rWr !== 0 || rWc !== 0) {
      let nr = rabbitPos.r + rWr;
      let nc = rabbitPos.c + rWc;
      if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
          rabbitPos = {r: nr, c: nc};
          addLog(`ğŸ‡ ã†ã•ãã‚‚é¢¨ã«æµã•ã‚Œã¾ã—ãŸï¼ (${rWr}, ${rWc})`);
          rMoved = true;
      } else {
          addLog("ğŸ‡ğŸ§± ã†ã•ãã¯å£ã«ã¶ã¤ã‹ã‚Šã¾ã—ãŸã€‚");
      }
  } else {
      // ã†ã•ãã®é¢¨ãªã—ãƒ­ã‚°ã¯çœç•¥ã—ã¦ã™ã£ãã‚Šã•ã›ã‚‹
  }

  // æ¼‚æµå¾Œã®åˆ¤å®š
  if (checkWin()) return; // æµã•ã‚Œã¦é‡ãªã£ãŸ
  if (checkLDeath(playerPos, "player")) return; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ­»äº¡
  if (checkLDeath(rabbitPos, "rabbit")) return; // ã†ã•ãæ­»äº¡

  driftStep++;
  
  // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š
  let [nextPWr, nextPWc] = getWindVector(playerPos.r, playerPos.c, board);
  let [nextRWr, nextRWc] = getWindVector(rabbitPos.r, rabbitPos.c, board);

  if (driftStep < 2 && ((nextPWr !==0 || nextPWc !==0) || (nextRWr !==0 || nextRWc !==0))) {
    addLog("ğŸŒªï¸ ã¾ã é¢¨ãŒå¹ã„ã¦ã„ã¾ã™ã€‚ã€Œè¿½åŠ ã§æ¼‚æµã€ã—ã¦ãã ã•ã„ã€‚");
    render(); 
  } else {
    addLog("âš“ï¸ æ¼‚æµãŒæ­¢ã¾ã‚Šã¾ã—ãŸã€‚");
    endDriftPhase();
  }
}

function endDriftPhase() {
  phase = "MOVE";
  turnCount++;
  updateTurnDisplay();
  addLog(`--- ã‚¿ãƒ¼ãƒ³ ${turnCount} é–‹å§‹ ---`);
  render();
}

// --- æç”»é–¢æ•° ---
function render() {
  const boardDiv = document.getElementById("board");
  boardDiv.innerHTML = "";
  
  for(let r=0; r<ROWS; r++) {
    for(let c=0; c<COLS; c++) {
      let cell = document.createElement("div");
      cell.className = "cell-container";
      
      let type = board[`${r},${c}`];
      if (type === "L") cell.classList.add("type-L");
      else if (type === "H") cell.classList.add("type-H");
      
      // ã†ã•ãã®ä½ç½®ã‚’å¼·èª¿
      if (rabbitPos.r === r && rabbitPos.c === c) cell.classList.add("rabbit-pos");
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®
      if (playerPos.r === r && playerPos.c === c) cell.classList.add("current-pos");
      
      for(let dr=-1; dr<=1; dr++) {
        for(let dc=-1; dc<=1; dc++) {
          let sub = document.createElement("div");
          sub.className = "sub-cell";
          
          if (dr===0 && dc===0) { 
            sub.classList.add("center-char");
            // è¡¨ç¤ºå„ªå…ˆé †ä½: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ > ã†ã•ã > L/H
            if (playerPos.r === r && playerPos.c === c) {
                sub.innerText = ICON_BALLOON;
            } else if (rabbitPos.r === r && rabbitPos.c === c) {
                sub.innerText = ICON_RABBIT;
            } else if (type === "L") {
                sub.innerText = "ä½";
            } else if (type === "H") {
                sub.innerText = "é«˜";
            }
          } else if (type) { 
            let w = (type === "L" ? L_WIND[`${dr},${dc}`] : H_WIND[`${dr},${dc}`]) || [0,0];
            let arrow = vecToArrow(w[0], w[1]);
            if (arrow) {
              sub.innerText = arrow;
              sub.classList.add("arrow");
            }
          }
          cell.appendChild(sub);
        }
      }
      boardDiv.appendChild(cell);
    }
  }
  
  document.getElementById("controls-move").style.display = "none";
  document.getElementById("controls-westerlies").style.display = "none";
  document.getElementById("controls-drift").style.display = "none";
  document.getElementById("controls-reset").style.display = gameOver ? "block" : "none";
  
  // çµ‚äº†æ™‚ã®ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ†å²
  let btnReset = document.getElementById("btn-reset");
  if (gameOver) {
    if (gameWon) {
        btnReset.innerText = "ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã™ã‚‹";
        btnReset.style.backgroundColor = "#4caf50"; // ç·‘è‰²
    } else {
        btnReset.innerText = "ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™";
        btnReset.style.backgroundColor = "#f44336"; // èµ¤è‰²
    }
  }
  
  let pTitle = document.getElementById("phase-title");
  
  if (!gameOver) {
    if (phase === "MOVE") {
      pTitle.innerText = "1. ç§»å‹•ã®æ“ä½œ";
      document.getElementById("controls-move").style.display = "grid";
    } else if (phase === "WESTERLIES") {
      pTitle.innerText = "2. åè¥¿é¢¨";
      document.getElementById("controls-westerlies").style.display = "block";
    } else if (phase === "DRIFT") {
      pTitle.innerText = driftStep === 0 ? "3. æ¼‚æµ (1å›ç›®)" : "3. æ¼‚æµ (2å›ç›®)";
      let btn = document.getElementById("btn-drift");
      btn.innerText = driftStep === 0 ? "ğŸŒŠ æ¼‚æµé–‹å§‹" : "ğŸŒŠğŸŒŠ è¿½åŠ ã§æ¼‚æµ";
      document.getElementById("controls-drift").style.display = "block";
    }
  } else {
    pTitle.innerText = gameWon ? "ğŸ‰ CONGRATULATIONS! ğŸ‰" : "ğŸ˜± GAME OVER...";
  }
}

initGame();
</script>
</body>
</html>