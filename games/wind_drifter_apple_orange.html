<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wind Drifter (Apple & Mandarin) - ã‚ˆã™ããƒ¼ã®éƒ¨å±‹</title>
<style>
  /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS) --- */
  body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f8ff; color: #455a64; max-width: 800px; margin: 0 auto; padding: 20px; }
  a.back-link { display: inline-block; margin-bottom: 15px; color: #78909c; text-decoration: none; font-size: 0.9em; }
  h1 { text-align: center; color: #ff7043; margin-top: 0; margin-bottom: 10px; text-shadow: 1px 1px 0px #fff; }
  
  .turn-indicator {
    text-align: center; font-size: 1.2rem; font-weight: bold; color: #546e7a;
    margin-bottom: 15px; padding: 8px 15px; background-color: #ffffff;
    border: 1px solid #cfd8dc; border-radius: 20px; display: inline-block;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .turn-wrapper { text-align: center; }

  .rules { background: #ffffff; padding: 15px; border-radius: 12px; margin-bottom: 20px; line-height: 1.6; border: 2px solid #ffe0b2; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .bold { font-weight: bold; color: #ff7043; }
  
  .game-board { display: grid; grid-template-columns: repeat(6, auto); gap: 4px; justify-content: center; margin-bottom: 20px; }
  
  .cell-container {
    display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
    width: 60px; height: 60px; border: 1px solid #cfd8dc; border-radius: 8px;
    background-color: #ffffff; font-size: 10px; position: relative; transition: all 0.2s;
  }
  
  .type-L { background-color: #ffebee; border: 2px solid #ef9a9a; color: #c62828; } 
  .type-H { background-color: #e3f2fd; border: 2px solid #90caf9; color: #1565c0; } 
  .type-TargetArea { background-color: #fffbe6; border: 1px dashed #ffd54f; }
  .type-Item { box-shadow: inset 0 0 15px rgba(255, 165, 0, 0.5); border: 2px solid #ff9800; }
  .current-pos { border: 3px solid #ffb74d !important; box-shadow: 0 0 10px rgba(255, 183, 77, 0.8); z-index: 10; transform: scale(1.05); }
  
  .sub-cell { display: flex; align-items: center; justify-content: center; }
  .center-char { font-weight: bold; font-size: 16px; }
  .arrow { font-size: 10px; opacity: 0.8; color: #607d8b; font-weight: bold;}
  
  .control-panel { background: #ffffff; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 1px solid #cfd8dc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .btn-group { display: grid; grid-template-columns: repeat(3, 50px); gap: 6px; justify-content: center; margin: 10px auto; }
  
  button { padding: 10px; cursor: pointer; font-size: 16px; border: 1px solid #b0bec5; border-radius: 8px; background: #eceff1; color: #455a64; transition: background 0.2s; }
  button:hover { background: #cfd8dc; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .action-btn { width: 100%; max-width: 250px; padding: 12px; font-weight: bold; background: #ff7043; color: white; border: none; border-radius: 20px; box-shadow: 0 4px 0 #d84315; }
  .action-btn:hover { background: #ff8a65; transform: translateY(2px); box-shadow: 0 2px 0 #d84315; }
  
  .log-area { width: 100%; height: 150px; border: 1px solid #cfd8dc; background: #f9fbe7; border-radius: 8px; overflow-y: scroll; padding: 10px; font-family: monospace; font-size: 13px; box-sizing: border-box; color: #333; }
  .log-entry { margin-bottom: 4px; border-bottom: 1px dotted #b0bec5; }
  
  @media (max-width: 600px) {
    .cell-container { width: 45px; height: 45px; font-size: 8px; border-radius: 6px; }
    .center-char { font-size: 12px; }
    .arrow { font-size: 8px; }
    .game-board { gap: 2px; }
    button { padding: 8px; font-size: 14px; }
    .btn-group { gap: 4px; grid-template-columns: repeat(3, 45px); }
  }
</style>
</head>
<body>

<a href="../minigames.html" class="back-link">â† ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ä¸€è¦§ã«æˆ»ã‚‹</a>

<h1>ğŸˆ Wind Drifter <span style="font-size:0.7em; color:#ff7043;">(ã‚Šã‚“ã”ã¿ã‹ã‚“)</span></h1>

<div class="rules">
  <p><span class="bold">ï¼œã‚Šã‚“ã”ã¿ã‹ã‚“ãƒ¢ãƒ¼ãƒ‰ï¼</span></p>
  <ul>
    <li>ã€Step 1ã€‘ å·¦å´ã‚¨ãƒªã‚¢ã«å‡ºç¾ã™ã‚‹<span class="bold" style="color:#ff5252;">ã€Œã‚Šã‚“ã”(ğŸ)ã€</span>ã‚’å–ã‚‹ã€‚</li>
    <li>ã€Step 2ã€‘ ã™ã‚‹ã¨å³å´ã‚¨ãƒªã‚¢ã«<span class="bold" style="color:#ff9800;">ã€Œã¿ã‹ã‚“(ğŸŠ)ã€</span>ãŒå‡ºç¾ã™ã‚‹ã®ã§ã€ãã‚Œã‚’å–ã‚Œã°ã‚¯ãƒªã‚¢ï¼</li>
  </ul>
  <p>â€»ãƒ•ãƒ«ãƒ¼ãƒ„ã¯é¢¨ã§æµã•ã‚Œãšã€ä½æ°—åœ§ã‚„é«˜æ°—åœ§ã¨é‡ãªã£ã¦ã‚‚æ¶ˆãˆã¾ã›ã‚“ã€‚</p>
</div>

<div class="turn-wrapper">
    <div class="turn-indicator">ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: <span id="turn-num">1</span></div>
</div>

<div id="board" class="game-board"></div>

<div class="control-panel">
  <h3 id="phase-title" style="color:#546e7a;">1. ç§»å‹•ã®æ“ä½œ</h3>
  <div id="controls-move" class="btn-group">
    <button onclick="actionMove(-1, -1)">â†–ï¸</button> <button onclick="actionMove(-1, 0)">â¬†ï¸</button> <button onclick="actionMove(-1, 1)">â†—ï¸</button>
    <button onclick="actionMove(0, -1)">â¬…ï¸</button> <button onclick="actionMove(0, 0)">â¹ï¸</button> <button onclick="actionMove(0, 1)">â¡ï¸</button>
    <button onclick="actionMove(1, -1)">â†™ï¸</button> <button onclick="actionMove(1, 0)">â¬‡ï¸</button> <button onclick="actionMove(1, 1)">â†˜ï¸</button>
  </div>
  
  <div id="controls-westerlies" style="display:none;">
    <button class="action-btn" onclick="actionWesterlies()">ğŸŒ¬ï¸ åè¥¿é¢¨é–‹å§‹</button>
  </div>
  
  <div id="controls-drift" style="display:none;">
    <button id="btn-drift" class="action-btn" onclick="actionDriftStep()">ğŸŒŠ æ¼‚æµé–‹å§‹</button>
  </div>
  
  <div id="controls-reset" style="display:none; margin-top:10px;">
    <button id="btn-reset" class="action-btn" onclick="initGame()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  </div>
</div>

<div class="bold" style="color:#546e7a;">å±¥æ­´</div>
<div id="logs" class="log-area"></div>

<script>
// --- è¨­å®šã¨å®šç¾© ---
const ROWS = 5;
const COLS = 6;
const ICON_BALLOON = "ğŸˆ";
const ICON_APPLE = "ğŸ";
const ICON_MANDARIN = "ğŸŠ";

const L_WIND = { "-1,-1": [1, 0], "-1,0": [1, -1], "-1,1": [0, -1], "0,-1": [1, 1], "0,1": [-1, -1], "1,-1": [0, 1], "1,0": [-1, 1], "1,1": [-1, 0] };
const H_WIND = { "-1,-1": [-1, 0], "-1,0": [-1, 1], "-1,1": [0, 1], "0,-1": [-1, -1], "0,1": [1, 1], "1,-1": [0, -1], "1,0": [1, -1], "1,1": [1, 0] };

function vecToArrow(r, c) {
  if (r==0 && c==0) return "";
  if (r==-1 && c==0) return "â¬†ï¸"; if (r==1 && c==0) return "â¬‡ï¸";
  if (r==0 && c==-1) return "â¬…ï¸"; if (r==0 && c==1) return "â¡ï¸";
  if (r==-1 && c==-1) return "â†–ï¸"; if (r==-1 && c==1) return "â†—ï¸";
  if (r==1 && c==-1) return "â†™ï¸"; if (r==1 && c==1) return "â†˜ï¸";
  return "";
}

// --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
let board = {}; 
let playerPos = {r: 2, c: 5};
let targetPos = {r: 0, c: 0}; 
let gameStage = "APPLE"; // "APPLE" -> "MANDARIN" -> "CLEARED"
let phase = "MOVE";
let driftStep = 0;
let gameOver = false;
let gameWon = false;
let turnCount = 1;

// --- åˆæœŸåŒ– ---
function initGame() {
  board = {};
  playerPos = {r: 2, c: 5};
  phase = "MOVE";
  gameStage = "APPLE";
  driftStep = 0;
  gameOver = false;
  gameWon = false;
  turnCount = 1;
  updateTurnDisplay();
  document.getElementById("logs").innerHTML = "";
  addLog("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ã¾ãšã¯å·¦ã® ğŸ ã‚’ç›®æŒ‡ã›ï¼");
  
  for(let c=0; c<3; c++) {
    let r = Math.floor(Math.random() * ROWS);
    board[`${r},${c}`] = Math.random() < 0.4 ? "L" : "H";
  }

  targetPos = {
      r: Math.floor(Math.random() * ROWS),
      c: Math.floor(Math.random() * 2)
  };

  render();
}

function updateTurnDisplay() {
    document.getElementById("turn-num").innerText = turnCount;
}

function addLog(msg) {
  const logDiv = document.getElementById("logs");
  const entry = document.createElement("div");
  entry.className = "log-entry";
  entry.innerText = msg;
  logDiv.prepend(entry);
}

function getWindVector(r, c, currentBoard) {
  let vectors = [];
  let ortho = [[-1,0], [1,0], [0,-1], [0,1]];
  let foundOrtho = false;
  
  for(let d of ortho) {
    let tr = r + d[0];
    let tc = c + d[1];
    let key = `${tr},${tc}`;
    if (currentBoard[key]) {
      let type = currentBoard[key];
      let relKey = `${-d[0]},${-d[1]}`;
      let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
      vectors.push(w);
      foundOrtho = true;
    }
  }
  
  if (!foundOrtho) {
    let diag = [[-1,-1], [-1,1], [1,-1], [1,1]];
    for(let d of diag) {
      let tr = r + d[0];
      let tc = c + d[1];
      let key = `${tr},${tc}`;
      if (currentBoard[key]) {
        let type = currentBoard[key];
        let relKey = `${-d[0]},${-d[1]}`;
        let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
        vectors.push(w);
      }
    }
  }
  
  if (vectors.length === 0) return [0, 0];
  
  let resR = 0, resC = 0;
  for(let v of vectors) { resR += v[0]; resC += v[1]; }
  
  if (Math.abs(resR)===1 && Math.abs(resC)>=3) { resR=0; resC = resC>0 ? 2 : -2; }
  if (Math.abs(resC)===1 && Math.abs(resR)>=3) { resC=0; resR = resR>0 ? 2 : -2; }
  
  return [resR, resC];
}

// --- ã‚¢ã‚¤ãƒ†ãƒ åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
function checkItem() {
    if (gameStage === "CLEARED") return true;

    if (playerPos.r === targetPos.r && playerPos.c === targetPos.c) {
        if (gameStage === "APPLE") {
            // ã‚Šã‚“ã”ã‚²ãƒƒãƒˆ -> ã¿ã‹ã‚“å‡ºç¾
            addLog("ğŸ ã‚Šã‚“ã”ã‚²ãƒƒãƒˆï¼æ¬¡ã¯å³ã® ğŸŠ ã‚’æ¢ã›ï¼");
            gameStage = "MANDARIN";
            
            targetPos = {
                r: Math.floor(Math.random() * ROWS),
                c: COLS - 1 - Math.floor(Math.random() * 2) 
            };
            
            render();
            return false; 

        } else if (gameStage === "MANDARIN") {
            // ã¿ã‹ã‚“ã‚²ãƒƒãƒˆ -> ã‚¯ãƒªã‚¢
            gameOver = true;
            gameWon = true; // å‹åˆ©ãƒ•ãƒ©ã‚°ON
            gameStage = "CLEARED";
            addLog(`ğŸŠ ã¿ã‹ã‚“ã‚²ãƒƒãƒˆï¼ (è¨˜éŒ²: ${turnCount}ã‚¿ãƒ¼ãƒ³) CLEAR!!`);
            render();
            return true;
        }
    }
    return false;
}

// --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

function actionMove(dr, dc) {
  if (gameOver) return;
  
  let pr = playerPos.r;
  let pc = playerPos.c;
  let nr = Math.max(0, Math.min(ROWS-1, pr + dr));
  let nc = Math.max(0, Math.min(COLS-1, pc + dc));
  
  if (board[`${nr},${nc}`] === "H") {
    addLog("âš ï¸ é«˜æ°—åœ§ã®å£ã«é˜»ã¾ã‚Œã¾ã—ãŸï¼(ç§»å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«)");
  } else {
    playerPos = {r: nr, c: nc};
    if (dr===0 && dc===0) addLog("ğŸ›‘ å¾…æ©Ÿã—ã¾ã—ãŸã€‚");
    else addLog("ğŸˆ æ°—çƒã‚’æ“ä½œã—ã¾ã—ãŸã€‚");
  }

  if (checkItem() && gameStage === "CLEARED") return;
  
  phase = "WESTERLIES";
  render();
}

function actionWesterlies() {
  if (gameOver) return;
  
  let newBoard = {};
  for(let key in board) {
    let [br, bc] = key.split(",").map(Number);
    if (bc + 1 < COLS) {
      newBoard[`${br},${bc+1}`] = board[key];
    }
  }
  board = newBoard;
  
  if (Math.random() < 0.8) {
    let spawnR = Math.floor(Math.random() * ROWS);
    let type = Math.random() < 0.4 ? "L" : "H";
    if (spawnR !== playerPos.r || 0 !== playerPos.c) {
      board[`${spawnR},0`] = type;
      addLog(`ğŸŒªï¸ è¥¿ã‹ã‚‰${type === 'L' ? 'ä½æ°—åœ§' : 'é«˜æ°—åœ§'}ãŒç™ºç”Ÿã€‚`);
    }
  } else {
    addLog("ğŸ’¨ æ–°ãŸãªæ“¾ä¹±ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
  
  phase = "DRIFT";
  driftStep = 0;
  render();
}

function actionDriftStep() {
  if (gameOver) return;
  
  // ã€ä¿®æ­£ã€‘æ¼‚æµé–‹å§‹æ™‚(é¢¨ãƒã‚§ãƒƒã‚¯å‰)ã«Lã«ã„ã‚‹å ´åˆ
  if (board[`${playerPos.r},${playerPos.c}`] === "L") {
    gameOver = true;
    gameWon = false;
    addLog("ğŸ’€ ä½æ°—åœ§ã®ä¸­å¿ƒã«å¸ã„è¾¼ã¾ã‚Œã¾ã—ãŸ... GAME OVER");
    render();
    return;
  }
  
  let [wr, wc] = getWindVector(playerPos.r, playerPos.c, board);
  
  if (wr === 0 && wc === 0) {
    addLog("ğŸƒ è¿‘ãã«é¢¨ã¯ãªãã€æ¼‚æµã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
    endDriftPhase();
    return;
  }
  
  let nr = playerPos.r + wr;
  let nc = playerPos.c + wc;
  
  if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
    playerPos = {r: nr, c: nc};
    addLog(`ğŸŒŠ é¢¨ã«æµã•ã‚Œã¦ã„ã¾ã™... (${wr}, ${wc})`);

    if (checkItem() && gameStage === "CLEARED") return;

    driftStep++;
  } else {
    addLog("ğŸ§± å£ã«ã¶ã¤ã‹ã‚Šã€æ¼‚æµã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    endDriftPhase();
    return;
  }
  
  // ã€ä¿®æ­£ã€‘æ¼‚æµç§»å‹•å¾Œã®Låˆ¤å®š
  if (board[`${playerPos.r},${playerPos.c}`] === "L") {
    gameOver = true;
    gameWon = false;
    addLog("ğŸ’€ ä½æ°—åœ§ã®ä¸­å¿ƒã«å¸ã„è¾¼ã¾ã‚Œã¾ã—ãŸ... GAME OVER");
    render();
    return;
  }
  
  let [nextWr, nextWc] = getWindVector(playerPos.r, playerPos.c, board);
  if (driftStep < 2 && (nextWr !== 0 || nextWc !== 0)) {
    addLog("ğŸŒªï¸ ã¾ã é¢¨ã«ä¹—ã£ã¦ã„ã¾ã™ã€‚ã€Œè¿½åŠ ã§æ¼‚æµã€ã—ã¦ãã ã•ã„ã€‚");
    render(); 
  } else {
    addLog("âš“ï¸ æ¼‚æµãŒæ­¢ã¾ã‚Šã¾ã—ãŸã€‚");
    endDriftPhase();
  }
}

function endDriftPhase() {
  phase = "MOVE";
  turnCount++;
  updateTurnDisplay();
  addLog(`--- ã‚¿ãƒ¼ãƒ³ ${turnCount} é–‹å§‹ ---`);
  render();
}

// --- æç”»é–¢æ•° ---
function render() {
  const boardDiv = document.getElementById("board");
  boardDiv.innerHTML = "";
  
  for(let r=0; r<ROWS; r++) {
    for(let c=0; c<COLS; c++) {
      let cell = document.createElement("div");
      cell.className = "cell-container";
      
      let type = board[`${r},${c}`];
      if (type === "L") cell.classList.add("type-L");
      else if (type === "H") cell.classList.add("type-H");
      
      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½®
      let isTargetPos = (r === targetPos.r && c === targetPos.c && gameStage !== "CLEARED");
      if (isTargetPos) {
          cell.classList.add("type-Item");
      }
      
      if (gameStage === "APPLE") {
        if (c <= 1) cell.classList.add("type-TargetArea");
      } else if (gameStage === "MANDARIN") {
        if (c >= COLS - 2) cell.classList.add("type-TargetArea");
      }
      
      if (playerPos.r === r && playerPos.c === c) cell.classList.add("current-pos");
      
      for(let dr=-1; dr<=1; dr++) {
        for(let dc=-1; dc<=1; dc++) {
          let sub = document.createElement("div");
          sub.className = "sub-cell";
          
          if (dr===0 && dc===0) { 
            sub.classList.add("center-char");
            // è¡¨ç¤ºå„ªå…ˆé †ä½: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ > ã‚¢ã‚¤ãƒ†ãƒ  > L/H
            if (playerPos.r === r && playerPos.c === c) {
                sub.innerText = ICON_BALLOON;
            } else if (isTargetPos) {
                sub.innerText = (gameStage === "APPLE") ? ICON_APPLE : ICON_MANDARIN;
            } else if (type === "L") {
                sub.innerText = "ä½";
            } else if (type === "H") {
                sub.innerText = "é«˜";
            }
          } else if (type) { 
            let w = (type === "L" ? L_WIND[`${dr},${dc}`] : H_WIND[`${dr},${dc}`]) || [0,0];
            let arrow = vecToArrow(w[0], w[1]);
            if (arrow) {
              sub.innerText = arrow;
              sub.classList.add("arrow");
            }
          }
          cell.appendChild(sub);
        }
      }
      boardDiv.appendChild(cell);
    }
  }
  
  document.getElementById("controls-move").style.display = "none";
  document.getElementById("controls-westerlies").style.display = "none";
  document.getElementById("controls-drift").style.display = "none";
  document.getElementById("controls-reset").style.display = gameOver ? "block" : "none";
  
  // çµ‚äº†æ™‚ã®ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ†å²
  let btnReset = document.getElementById("btn-reset");
  if (gameOver) {
    if (gameWon) {
        btnReset.innerText = "ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã™ã‚‹";
        btnReset.style.backgroundColor = "#66bb6a"; // ç·‘è‰²
        btnReset.style.boxShadow = "0 4px 0 #388e3c";
    } else {
        btnReset.innerText = "ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™";
        btnReset.style.backgroundColor = "#ffa726"; // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
        btnReset.style.boxShadow = "0 4px 0 #ef6c00";
    }
  }
  
  let pTitle = document.getElementById("phase-title");
  
  if (!gameOver) {
    if (phase === "MOVE") {
      pTitle.innerText = "1. ç§»å‹•ã®æ“ä½œ";
      document.getElementById("controls-move").style.display = "grid";
    } else if (phase === "WESTERLIES") {
      pTitle.innerText = "2. åè¥¿é¢¨";
      document.getElementById("controls-westerlies").style.display = "block";
    } else if (phase === "DRIFT") {
      pTitle.innerText = driftStep === 0 ? "3. æ¼‚æµ (1å›ç›®)" : "3. æ¼‚æµ (2å›ç›®)";
      let btn = document.getElementById("btn-drift");
      btn.innerText = driftStep === 0 ? "ğŸŒŠ æ¼‚æµé–‹å§‹" : "ğŸŒŠğŸŒŠ è¿½åŠ ã§æ¼‚æµ";
      document.getElementById("controls-drift").style.display = "block";
    }
  } else {
    pTitle.innerText = gameWon ? "ğŸ‰ CONGRATULATIONS! ğŸ‰" : "ã‚²ãƒ¼ãƒ çµ‚äº†";
    pTitle.style.color = gameWon ? "#43a047" : "#546e7a";
  }
}

initGame();
</script>
</body>
</html>