<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wind Drifter (é«˜é›£æ˜“åº¦) - ã‚ˆã™ããƒ¼ã®éƒ¨å±‹</title>
<style>
  /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS) --- */
  body { font-family: sans-serif; background-color: #2b2b2b; color: #f0f0f0; max-width: 900px; margin: 0 auto; padding: 20px; }
  h1 { text-align: center; color: #ff5252; text-shadow: 2px 2px #000; }
  .rules { background: #424242; padding: 15px; border-radius: 8px; margin-bottom: 20px; line-height: 1.6; border: 1px solid #ff5252; }
  .bold { font-weight: bold; color: #ffcc00; }
  
  /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢å…¨ä½“ (äºˆå ± + ç›¤é¢) */
  .game-container {
    display: flex;
    justify-content: center;
    gap: 15px; /* äºˆå ±ã¨ç›¤é¢ã®éš™é–“ */
    margin-bottom: 20px;
  }

  /* äºˆå ±ã‚¨ãƒªã‚¢ (å·¦å´) */
  .forecast-area {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .forecast-label { font-size: 12px; color: #aaa; margin-bottom: 5px; font-weight: bold; }
  .forecast-grid {
    display: grid;
    grid-template-rows: repeat(5, auto); /* 5è¡Œ */
    gap: 4px;
  }
  .forecast-cell {
    width: 60px; height: 60px;
    border: 2px dashed #777; /* ç‚¹ç·šã§ã€Œã¾ã æ¥ã¦ãªã„æ„Ÿã€ã‚’å‡ºã™ */
    border-radius: 4px;
    background-color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    opacity: 0.7;
  }

  /* ç›¤é¢ã‚°ãƒªãƒƒãƒ‰ */
  .game-board {
    display: grid;
    grid-template-columns: repeat(6, auto); /* 6åˆ— */
    gap: 4px;
  }
  
  /* 1ãƒã‚¹ã®è¨­å®š */
  .cell-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    width: 60px; height: 60px;
    border: 1px solid #555;
    border-radius: 4px;
    background-color: #333;
    font-size: 10px;
    position: relative;
  }
  
  /* ãƒã‚¹ã®è‰²åˆ†ã‘ */
  .type-L { background-color: #5a2a2a; border: 2px solid #ef5350; color: #ffcdd2; } 
  .type-H { background-color: #1a3a5a; border: 2px solid #42a5f5; color: #bbdefb; }
  .type-Goal { background-color: #1b5e20; border: 2px dashed #66bb6a; }
  .current-pos { border: 3px solid #ffab00 !important; box-shadow: 0 0 10px rgba(255, 171, 0, 0.8); z-index: 10; }
  
  /* ãƒã‚¹ã®ä¸­èº« */
  .sub-cell { display: flex; align-items: center; justify-content: center; }
  .center-char { font-weight: bold; font-size: 16px; }
  .arrow { font-size: 10px; opacity: 0.9; color: #fff; font-weight: bold;}
  
  /* æ“ä½œãƒ‘ãƒãƒ« */
  .control-panel { background: #424242; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
  .btn-group { display: grid; grid-template-columns: repeat(3, 50px); gap: 5px; justify-content: center; margin: 10px auto; }
  button { padding: 10px; cursor: pointer; font-size: 16px; border: 1px solid #777; border-radius: 4px; background: #616161; color: white; }
  button:hover { background: #757575; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .action-btn { width: 100%; max-width: 200px; padding: 12px; font-weight: bold; background: #c62828; color: white; border: none; }
  .action-btn:hover { background: #d32f2f; }
  
  /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
  .log-area { width: 100%; height: 150px; border: 1px solid #555; background: #333; color: #ddd; overflow-y: scroll; padding: 10px; font-family: monospace; font-size: 13px; box-sizing: border-box; }
  .log-entry { margin-bottom: 4px; border-bottom: 1px dotted #555; }
</style>
</head>
<body>

<h1>ğŸˆ Wind Drifter <span style="font-size:0.7em; color:#ffcc00;">(é«˜é›£æ˜“åº¦)</span></h1>

<div class="rules">
  <p><span class="bold">ï¼œNextäºˆå ±ã‚·ã‚¹ãƒ†ãƒ æ­è¼‰ï¼</span><br>
  ç›¤é¢ã®å·¦å´ã«ã€Œæ¬¡ã«æ¥ã‚‹æ“¾ä¹±ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ãƒ’ãƒ³ãƒˆã«ä½ç½®å–ã‚Šã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚</p>
  <p><span class="bold">ï¼œãƒ«ãƒ¼ãƒ«ï¼</span></p>
  <ul>
    <li>æ¯ã‚¿ãƒ¼ãƒ³ã®æµã‚Œã¯ã€ã€Œç§»å‹•ã€â†’ã€Œåè¥¿é¢¨ã€â†’ã€Œæ¼‚æµã€ã§ã™ã€‚</li>
    <li><span class="bold">ã€Œç§»å‹•ã€</span>ï¼šæ°—çƒã‚’å¥½ããªå‘ãã«ï¼‘ãƒã‚¹ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è‡ªåˆ†ã‹ã‚‰é«˜æ°—åœ§ã«å…¥ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</li>
    <li><span class="bold">ã€Œåè¥¿é¢¨ã€</span>ï¼šã™ã¹ã¦ã®æ“¾ä¹±ãŒå³ã«ï¼‘ãƒã‚¹ç§»å‹•ã—ã¾ã™ã€‚åŒæ™‚ã«ã€<span class="bold">äºˆå ±ã‚¨ãƒªã‚¢ã«ã‚ã£ãŸæ“¾ä¹±</span>ãŒä¸€ç•ªå·¦ã®åˆ—ã«å‡ºç¾ã—ã¾ã™ã€‚</li>
    <li><span class="bold">ã€Œæ¼‚æµã€</span>ï¼šæ°—çƒã¯ã€å‘¨å›²ã®é¢¨ã®å½±éŸ¿ã‚’å—ã‘ã¦æ¼‚æµã—ã¾ã™ã€‚æ¼‚æµå¾Œã«ã•ã‚‰ã«æ¼‚æµã§ãã‚‹å ´åˆã¯ã€ï¼’å›ã¾ã§æ¼‚æµã—ã¾ã™ã€‚</li>
  </ul>
</div>

<div class="game-container">
  <div class="forecast-area">
    <div class="forecast-label">NEXT â–¶</div>
    <div id="forecast-grid" class="forecast-grid"></div>
  </div>

  <div id="board" class="game-board"></div>
</div>

<div class="control-panel">
  <h3 id="phase-title">1. ç§»å‹•ã®æ“ä½œ</h3>
  <div id="controls-move" class="btn-group">
    <button onclick="actionMove(-1, -1)">â†–ï¸</button> <button onclick="actionMove(-1, 0)">â¬†ï¸</button> <button onclick="actionMove(-1, 1)">â†—ï¸</button>
    <button onclick="actionMove(0, -1)">â¬…ï¸</button> <button onclick="actionMove(0, 0)">â¹ï¸</button> <button onclick="actionMove(0, 1)">â¡ï¸</button>
    <button onclick="actionMove(1, -1)">â†™ï¸</button> <button onclick="actionMove(1, 0)">â¬‡ï¸</button> <button onclick="actionMove(1, 1)">â†˜ï¸</button>
  </div>
  
  <div id="controls-westerlies" style="display:none;">
    <button class="action-btn" onclick="actionWesterlies()">ğŸŒ¬ï¸ åè¥¿é¢¨é–‹å§‹</button>
  </div>
  
  <div id="controls-drift" style="display:none;">
    <button id="btn-drift" class="action-btn" onclick="actionDriftStep()">ğŸŒŠ æ¼‚æµé–‹å§‹</button>
  </div>
  
  <div id="controls-reset" style="display:none; margin-top:10px;">
    <button class="action-btn" style="background:#ff9800; color:black;" onclick="initGame()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
  </div>
</div>

<div class="bold">å±¥æ­´</div>
<div id="logs" class="log-area"></div>

<script>
// --- è¨­å®šã¨å®šç¾© ---
const ROWS = 5;
const COLS = 6;
const ICON_BALLOON = "ğŸˆ";
const ICON_GOAL = "ğŸ";

const L_WIND = {
  "-1,-1": [1, 0],  "-1,0": [1, -1],  "-1,1": [0, -1],
  "0,-1":  [1, 1],                    "0,1":  [-1, -1],
  "1,-1":  [0, 1],  "1,0":  [-1, 1],  "1,1":  [-1, 0]
};
const H_WIND = {
  "-1,-1": [-1, 0], "-1,0": [-1, 1],  "-1,1": [0, 1],
  "0,-1":  [-1, -1],                  "0,1":  [1, 1],
  "1,-1":  [0, -1], "1,0":  [1, -1],  "1,1":  [1, 0]
};

function vecToArrow(r, c) {
  if (r==0 && c==0) return "";
  if (r==-1 && c==0) return "â¬†ï¸"; if (r==1 && c==0) return "â¬‡ï¸";
  if (r==0 && c==-1) return "â¬…ï¸"; if (r==0 && c==1) return "â¡ï¸";
  if (r==-1 && c==-1) return "â†–ï¸"; if (r==-1 && c==1) return "â†—ï¸";
  if (r==1 && c==-1) return "â†™ï¸"; if (r==1 && c==1) return "â†˜ï¸";
  return "";
}

// --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
let board = {}; 
let nextSpawns = {}; // Key: "row", Value: "L" or "H" (äºˆå ±ç”¨ãƒ‡ãƒ¼ã‚¿)
let playerPos = {r: 2, c: 5};
let phase = "MOVE"; 
let driftStep = 0;
let gameOver = false;
let turnCount = 1;

// --- åˆæœŸåŒ– ---
function initGame() {
  board = {};
  nextSpawns = {}; // äºˆå ±åˆæœŸåŒ–
  playerPos = {r: 2, c: 5};
  phase = "MOVE";
  driftStep = 0;
  gameOver = false;
  turnCount = 1;
  document.getElementById("logs").innerHTML = "";
  addLog("é«˜é›£æ˜“åº¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼Nextäºˆå ±ã‚’ç¢ºèªã—ã¦ç§»å‹•ã—ã¾ã—ã‚‡ã†ã€‚");
  
  // åˆæœŸé…ç½® (å·¦3åˆ—)
  for(let c=0; c<3; c++) {
    let placedCount = 0;
    while(placedCount < 2) {
      let r = Math.floor(Math.random() * ROWS);
      if (!board[`${r},${c}`]) {
        board[`${r},${c}`] = Math.random() < 0.4 ? "L" : "H";
        placedCount++;
      }
    }
  }

  // æœ€åˆã®äºˆå ±ã‚’ä½œæˆ
  generateNextSpawns();
  
  render();
}

// æ¬¡ã®ç™ºç”Ÿ(äºˆå ±ãƒ‡ãƒ¼ã‚¿)ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function generateNextSpawns() {
  nextSpawns = {};
  // é«˜é›£æ˜“åº¦: æœ€å¤§2ã¤ç™ºç”Ÿ
  let count = 0;
  for(let i=0; i<2; i++) {
    if (Math.random() < 0.8) {
      let r = Math.floor(Math.random() * ROWS);
      // åŒã˜è¡Œã«é‡è¤‡ã•ã›ãªã„
      if (!nextSpawns[r]) {
        nextSpawns[r] = Math.random() < 0.4 ? "L" : "H";
        count++;
      }
    }
  }
}

// --- ãƒ­ã‚°æ©Ÿèƒ½ ---
function addLog(msg) {
  const logDiv = document.getElementById("logs");
  const entry = document.createElement("div");
  entry.className = "log-entry";
  entry.innerText = msg;
  logDiv.prepend(entry);
}

// --- é¢¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
function getWindVector(r, c, currentBoard) {
  let vectors = [];
  let ortho = [[-1,0], [1,0], [0,-1], [0,1]];
  let foundOrtho = false;
  
  for(let d of ortho) {
    let tr = r + d[0];
    let tc = c + d[1];
    let key = `${tr},${tc}`;
    if (currentBoard[key]) {
      let type = currentBoard[key];
      let relKey = `${-d[0]},${-d[1]}`;
      let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
      vectors.push(w);
      foundOrtho = true;
    }
  }
  
  if (!foundOrtho) {
    let diag = [[-1,-1], [-1,1], [1,-1], [1,1]];
    for(let d of diag) {
      let tr = r + d[0];
      let tc = c + d[1];
      let key = `${tr},${tc}`;
      if (currentBoard[key]) {
        let type = currentBoard[key];
        let relKey = `${-d[0]},${-d[1]}`;
        let w = (type === "L" ? L_WIND[relKey] : H_WIND[relKey]) || [0,0];
        vectors.push(w);
      }
    }
  }
  
  if (vectors.length === 0) return [0, 0];
  
  let resR = 0, resC = 0;
  for(let v of vectors) { resR += v[0]; resC += v[1]; }
  
  if (Math.abs(resR)===1 && Math.abs(resC)>=3) { resR=0; resC = resC>0 ? 2 : -2; }
  if (Math.abs(resC)===1 && Math.abs(resR)>=3) { resC=0; resR = resR>0 ? 2 : -2; }
  
  return [resR, resC];
}

// --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

function actionMove(dr, dc) {
  if (gameOver) return;
  
  let pr = playerPos.r;
  let pc = playerPos.c;
  let nr = Math.max(0, Math.min(ROWS-1, pr + dr));
  let nc = Math.max(0, Math.min(COLS-1, pc + dc));
  
  if (board[`${nr},${nc}`] === "H") {
    addLog("âš ï¸ é«˜æ°—åœ§ã®å£ã«é˜»ã¾ã‚Œã¾ã—ãŸï¼(ç§»å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«)");
  } else {
    playerPos = {r: nr, c: nc};
    if (dr===0 && dc===0) addLog("ğŸ›‘ å¾…æ©Ÿã—ã¾ã—ãŸã€‚");
    else addLog("ğŸˆ æ°—çƒã‚’æ“ä½œã—ã¾ã—ãŸã€‚");
  }
  
  phase = "WESTERLIES";
  render();
}

function actionWesterlies() {
  if (gameOver) return;
  
  // 1. æ—¢å­˜ã®ç›¤é¢ã‚’å³ã‚·ãƒ•ãƒˆ
  let newBoard = {};
  for(let key in board) {
    let [br, bc] = key.split(",").map(Number);
    if (bc + 1 < COLS) {
      newBoard[`${br},${bc+1}`] = board[key];
    }
  }
  board = newBoard;
  
  // 2. äºˆå ±(nextSpawns)ã«ã‚ã£ãŸã‚‚ã®ã‚’0åˆ—ç›®ã«é…ç½®
  let spawnedMsg = [];
  for(let r in nextSpawns) {
    let type = nextSpawns[r];
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãã“ã«ã„ã¦ã‚‚ã€å£ã«ãªã£ã¦ã„ãªã‘ã‚Œã°å‡ºç¾ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã«ã—ã¾ã™ï¼ˆå³æ­»ãƒªã‚¹ã‚¯ï¼‰
    // ã‚‚ã—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã«ã¯ç™ºç”Ÿã•ã›ãŸããªã„å ´åˆã¯ if (Number(r) !== playerPos.r || playerPos.c !== 0) ã‚’è¿½åŠ 
    if (Number(r) !== playerPos.r || playerPos.c !== 0) {
        board[`${r},0`] = type;
        spawnedMsg.push(type === 'L' ? 'ä½' : 'é«˜');
    }
  }
  
  if (spawnedMsg.length > 0) addLog(`ğŸŒªï¸ åè¥¿é¢¨ã«ã‚ˆã‚Š ${spawnedMsg.join(",")} ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`);
  else addLog("ğŸ’¨ æ–°ãŸãªæ“¾ä¹±ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã§ã—ãŸã€‚");

  // 3. æ¬¡ã®äºˆå ±ã‚’ä½œæˆ
  generateNextSpawns();
  
  phase = "DRIFT";
  driftStep = 0;
  render();
}

function actionDriftStep() {
  if (gameOver) return;
  
  let [wr, wc] = getWindVector(playerPos.r, playerPos.c, board);
  
  if (wr === 0 && wc === 0) {
    addLog("ğŸƒ è¿‘ãã«é¢¨ã¯ãªãã€æ¼‚æµã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
    endDriftPhase();
    return;
  }
  
  let nr = playerPos.r + wr;
  let nc = playerPos.c + wc;
  
  if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
    playerPos = {r: nr, c: nc};
    addLog(`ğŸŒŠ é¢¨ã«æµã•ã‚Œã¦ã„ã¾ã™... (${wr}, ${wc})`);
    driftStep++;
  } else {
    addLog("ğŸ§± å£ã«ã¶ã¤ã‹ã‚Šã€æ¼‚æµã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    endDriftPhase();
    return;
  }
  
  if (board[`${playerPos.r},${playerPos.c}`] === "L") {
    gameOver = true;
    addLog("ğŸ’€ ä½æ°—åœ§ã®ä¸­å¿ƒã«å¸ã„è¾¼ã¾ã‚Œã¾ã—ãŸ... GAME OVER");
    render();
    return;
  }
  
  let [nextWr, nextWc] = getWindVector(playerPos.r, playerPos.c, board);
  if (driftStep < 2 && (nextWr !== 0 || nextWc !== 0)) {
    addLog("ğŸŒªï¸ ã¾ã é¢¨ã«ä¹—ã£ã¦ã„ã¾ã™ã€‚ã€Œè¿½åŠ ã§æ¼‚æµã€ã—ã¦ãã ã•ã„ã€‚");
    render(); 
  } else {
    addLog("âš“ï¸ æ¼‚æµãŒæ­¢ã¾ã‚Šã¾ã—ãŸã€‚");
    endDriftPhase();
  }
}

function endDriftPhase() {
  if (playerPos.c === 0) {
    gameOver = true;
    addLog("ğŸ‰ ã‚´ãƒ¼ãƒ«åˆ°é”ï¼ CLEAR!!");
    render();
    return;
  }
  phase = "MOVE";
  turnCount++;
  addLog(`--- ã‚¿ãƒ¼ãƒ³ ${turnCount} é–‹å§‹ ---`);
  render();
}

// --- æç”»é–¢æ•° ---
function render() {
  // 1. äºˆå ±ã‚¨ãƒªã‚¢ã®æç”»
  const forecastDiv = document.getElementById("forecast-grid");
  forecastDiv.innerHTML = "";
  for(let r=0; r<ROWS; r++) {
    let cell = document.createElement("div");
    cell.className = "forecast-cell";
    if (nextSpawns[r]) {
      // äºˆå ±ãŒã‚ã‚‹å ´åˆ
      let type = nextSpawns[r];
      cell.innerText = type === 'L' ? "ä½" : "é«˜";
      cell.style.color = type === 'L' ? "#ef5350" : "#42a5f5";
    } else {
      cell.innerText = "";
    }
    forecastDiv.appendChild(cell);
  }

  // 2. ãƒ¡ã‚¤ãƒ³ç›¤é¢ã®æç”»
  const boardDiv = document.getElementById("board");
  boardDiv.innerHTML = "";
  
  for(let r=0; r<ROWS; r++) {
    for(let c=0; c<COLS; c++) {
      let cell = document.createElement("div");
      cell.className = "cell-container";
      
      let type = board[`${r},${c}`];
      if (type === "L") cell.classList.add("type-L");
      else if (type === "H") cell.classList.add("type-H");
      else if (c === 0) cell.classList.add("type-Goal");
      
      if (playerPos.r === r && playerPos.c === c) cell.classList.add("current-pos");
      
      for(let dr=-1; dr<=1; dr++) {
        for(let dc=-1; dc<=1; dc++) {
          let sub = document.createElement("div");
          sub.className = "sub-cell";
          
          if (dr===0 && dc===0) { 
            sub.classList.add("center-char");
            if (playerPos.r === r && playerPos.c === c) sub.innerText = ICON_BALLOON;
            else if (type === "L") sub.innerText = "ä½";
            else if (type === "H") sub.innerText = "é«˜";
            else if (c === 0) sub.innerText = ICON_GOAL;
          } else if (type) { 
            let w = (type === "L" ? L_WIND[`${dr},${dc}`] : H_WIND[`${dr},${dc}`]) || [0,0];
            let arrow = vecToArrow(w[0], w[1]);
            if (arrow) {
              sub.innerText = arrow;
              sub.classList.add("arrow");
            }
          }
          cell.appendChild(sub);
        }
      }
      boardDiv.appendChild(cell);
    }
  }
  
  document.getElementById("controls-move").style.display = "none";
  document.getElementById("controls-westerlies").style.display = "none";
  document.getElementById("controls-drift").style.display = "none";
  document.getElementById("controls-reset").style.display = gameOver ? "block" : "none";
  
  let pTitle = document.getElementById("phase-title");
  
  if (!gameOver) {
    if (phase === "MOVE") {
      pTitle.innerText = "1. ç§»å‹•ã®æ“ä½œ";
      document.getElementById("controls-move").style.display = "grid";
    } else if (phase === "WESTERLIES") {
      pTitle.innerText = "2. åè¥¿é¢¨";
      document.getElementById("controls-westerlies").style.display = "block";
    } else if (phase === "DRIFT") {
      pTitle.innerText = driftStep === 0 ? "3. æ¼‚æµ (1å›ç›®)" : "3. æ¼‚æµ (2å›ç›®)";
      let btn = document.getElementById("btn-drift");
      btn.innerText = driftStep === 0 ? "ğŸŒŠ æ¼‚æµé–‹å§‹" : "ğŸŒŠğŸŒŠ è¿½åŠ ã§æ¼‚æµ";
      document.getElementById("controls-drift").style.display = "block";
    }
  } else {
    pTitle.innerText = "ã‚²ãƒ¼ãƒ çµ‚äº†";
  }
}

initGame();
</script>
</body>
</html>